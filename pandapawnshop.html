<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panda Pawn Shop</title>

<style>
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Orbitron', Arial, sans-serif;
    background: #000;
    color: #f5e9ff;
    padding-bottom: 100px;
  }

  /* Fixed Header */
  .fixed-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    border-bottom: 2px solid #7a2bf8;
    padding: 15px 20px;
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .header-logo {
    font-size: 1.2em;
    font-weight: bold;
    color: #bb33ff;
  }

  .header-center {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }

  .docs-btn {
    padding: 8px 16px;
    background: linear-gradient(135deg, #1a0a2e, #2d1b4e);
    border: 2px solid #bb33ff;
    border-radius: 8px;
    color: #bb33ff;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.85em;
    font-weight: bold;
    transition: all 0.3s;
  }

  .docs-btn:hover {
    background: linear-gradient(135deg, #bb33ff, #7a2bf8);
    color: white;
    box-shadow: 0 0 15px rgba(187, 51, 255, 0.5);
  }

  .header-stats {
    display: flex;
    gap: 20px;
    font-size: 0.85em;
  }

  .header-stat {
    color: #caffff;
  }

  .header-stat span {
    color: #bb33ff;
    font-weight: bold;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  #connect-wallet-btn {
    padding: 12px 20px;
    font-size: 0.95em;
    font-weight: bold;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #bb33ff, #7a2bf8);
    color: white;
    box-shadow: 0 0 12px #bb33ff, 0 0 26px #a020f0;
    animation: neonPulse 2s infinite;
  }

  #connect-wallet-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    animation: none;
  }

  @keyframes neonPulse {
    0%,100% { box-shadow: 0 0 12px #bb33ff,0 0 26px #a020f0,0 0 48px #bb33ff; }
    50% { box-shadow: 0 0 24px #d175ff,0 0 48px #bb33ff,0 0 90px #d175ff; }
  }

  #wallet-display {
    font-size: 0.85em;
    color: #caffff;
    text-align: right;
  }

  .container { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 100px 20px 60px; 
  }

  .title { 
    text-align: center; 
    margin-bottom: 30px; 
  }

  .title img {
    max-width: 420px;
    width: 90%;
    filter: drop-shadow(0 0 18px #bb33ff) drop-shadow(0 0 36px #a020f0) drop-shadow(0 0 64px #bb33ff);
    animation: titleGlow 2.2s infinite ease-in-out;
  }

  @keyframes titleGlow {
    0%,100% {
      filter: drop-shadow(0 0 18px #bb33ff) drop-shadow(0 0 36px #a020f0) drop-shadow(0 0 64px #bb33ff);
    }
    50% {
      filter: drop-shadow(0 0 30px #d175ff) drop-shadow(0 0 60px #bb33ff) drop-shadow(0 0 110px #d175ff);
    }
  }

  .summary { 
    max-width: 780px; 
    margin: 0 auto 30px; 
    text-align: center; 
    line-height: 1.7; 
    font-size: 1.05em; 
    color: #dacafa; 
  }

  /* Global Stats Section */
  .global-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: linear-gradient(135deg, #1a0a2e, #0d0015);
    border: 2px solid #7a2bf8;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
  }

  .stat-card .stat-label {
    font-size: 0.75em;
    color: #888;
    margin-bottom: 5px;
  }

  .stat-card .stat-value {
    font-size: 1.3em;
    font-weight: bold;
    color: #bb33ff;
  }

  .stat-card .stat-value.green {
    color: #00ff88;
  }

  .stat-card .stat-value.red {
    color: #ff4444;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 12px 24px;
    background: #1a0a2e;
    border: 2px solid #453c2c;
    border-radius: 10px;
    color: #dacafa;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.95em;
    transition: all 0.3s;
    position: relative;
  }

  .tab-btn:hover {
    border-color: #7a2bf8;
  }

  .tab-btn.active {
    background: linear-gradient(135deg, #bb33ff, #7a2bf8);
    border-color: #bb33ff;
    color: white;
  }

  .tab-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .tab-btn .badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ff4444;
    color: white;
    font-size: 0.7em;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: bold;
  }

  .tab-btn .coming-soon {
    font-size: 0.7em;
    display: block;
    color: #888;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .section { 
    background: #120c1f; 
    border: 2px solid #7a2bf8; 
    border-radius: 18px; 
    padding: 24px; 
    margin-bottom: 30px; 
    box-shadow: 0 0 24px rgba(122,43,248,0.35); 
  }

  .section h2 { 
    margin-top: 0; 
    color: #e2c7ff; 
    text-shadow: 0 0 10px #bb33ff; 
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .floor-badge {
    font-size: 0.6em;
    background: #00ff88;
    color: #000;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
  }

  .nft-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
    gap: 18px; 
  }

  .nft-card { 
    background: #000; 
    border-radius: 14px; 
    border: 2px solid #453c2c; 
    padding: 12px; 
    text-align: center; 
    cursor: pointer; 
    transition: transform 0.2s, box-shadow 0.2s; 
  }

  .nft-card:hover { 
    transform: translateY(-4px); 
    box-shadow: 0 0 18px #bb33ff; 
  }

  .nft-card.selected { 
    border-color: #bb33ff; 
    box-shadow: 0 0 18px #bb33ff; 
  }

  .nft-card img { 
    width: 100%; 
    border-radius: 10px; 
    margin-bottom: 8px; 
    min-height: 150px; 
    object-fit: cover; 
    background: #1a1a1a; 
  }

  .nft-card .nft-name { 
    font-size: 0.85em; 
    color: #dacafa; 
    word-break: break-word; 
  }

  .preview { 
    text-align: center; 
  }

  .preview img { 
    max-width: 260px; 
    border-radius: 18px; 
    border: 3px solid #bb33ff; 
    box-shadow: 0 0 28px rgba(187,51,255,0.6); 
  }

  .loan-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 18px; 
  }

  .loan-box { 
    background: #000; 
    border: 2px solid #453c2c; 
    border-radius: 14px; 
    padding: 16px; 
    text-align: center; 
  }

  .action-btn { 
    margin-top: 18px; 
    padding: 14px 28px; 
    border-radius: 12px; 
    border: none; 
    font-size: 1.05em; 
    font-weight: bold; 
    background: linear-gradient(135deg, #bb33ff, #892dff); 
    color: #fff; 
    cursor: pointer; 
    display: inline-flex; 
    align-items: center; 
    gap: 10px; 
    box-shadow: 0 0 22px rgba(187,51,255,0.45); 
    font-family: inherit;
  }

  .action-btn:disabled { 
    opacity: 0.4; 
    cursor: not-allowed; 
  }

  .action-btn img { 
    width: 28px; 
    height: 28px; 
  }

  .action-btn.green {
    background: linear-gradient(135deg, #00ff88, #00cc6a);
    color: #000;
  }

  .countdown { 
    margin-top: 15px; 
    font-size: 1.1em; 
    color: #ffbfff; 
  }

  .error-message { 
    color: #ff6b6b; 
    margin-top: 10px; 
    padding: 10px; 
    background: rgba(255,107,107,0.1); 
    border-radius: 8px; 
  }

  .loading { 
    color: #bb33ff; 
  }

  /* Active Loans */
  .active-loans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
  }

  .loan-card {
    background: linear-gradient(135deg, #1a0a2e, #0d0015);
    border: 2px solid #7a2bf8;
    border-radius: 16px;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .loan-card.urgent {
    border-color: #ff4444;
    animation: urgentPulse 1s infinite;
  }

  @keyframes urgentPulse {
    0%, 100% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.3); }
    50% { box-shadow: 0 0 40px rgba(255, 68, 68, 0.6); }
  }

  .loan-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
  }

  .loan-card-nft {
    width: 80px;
    height: 80px;
    border-radius: 10px;
    object-fit: cover;
    border: 2px solid #bb33ff;
    background: #1a1a1a;
  }

  .loan-card-info {
    flex: 1;
    margin-left: 15px;
  }

  .loan-card-title {
    font-size: 1em;
    color: #e2c7ff;
    margin-bottom: 5px;
  }

  .loan-card-id {
    font-size: 0.8em;
    color: #888;
  }

  .loan-card-timer {
    text-align: center;
    padding: 15px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    margin-bottom: 15px;
  }

  .timer-label {
    font-size: 0.8em;
    color: #888;
    margin-bottom: 5px;
  }

  .timer-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #00ff88;
  }

  .timer-value.warning {
    color: #ffaa00;
  }

  .timer-value.danger {
    color: #ff4444;
  }

  .loan-card-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
  }

  .loan-detail {
    text-align: center;
  }

  .loan-detail-label {
    font-size: 0.7em;
    color: #888;
  }

  .loan-detail-value {
    font-size: 0.95em;
    color: #caffff;
    font-weight: bold;
  }

  .repay-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #00ff88, #00cc6a);
    color: #000;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    font-family: inherit;
    font-size: 1em;
    transition: transform 0.2s;
  }

  .repay-btn:hover {
    transform: scale(1.02);
  }

  .no-loans-message {
    text-align: center;
    padding: 60px 20px;
    color: #888;
  }

  .no-loans-message h3 {
    color: #bb33ff;
    margin-bottom: 10px;
  }

  /* Collection Selector */
  .collection-selector {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .collection-btn {
    padding: 12px 20px;
    background: #1a0a2e;
    border: 2px solid #453c2c;
    border-radius: 10px;
    color: #dacafa;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .collection-btn:hover:not(.disabled) {
    border-color: #7a2bf8;
  }

  .collection-btn.active {
    background: linear-gradient(135deg, #bb33ff, #7a2bf8);
    border-color: #bb33ff;
    color: white;
  }

  .collection-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .collection-btn img {
    width: 30px;
    height: 30px;
    border-radius: 50%;
  }

  .collection-btn .coming-soon-text {
    font-size: 0.7em;
    color: #888;
  }

  /* Modals */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: linear-gradient(135deg, #1a0a2e, #0d0015);
    border: 3px solid #bb33ff;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    max-width: 450px;
    width: 100%;
    box-shadow: 0 0 50px rgba(187, 51, 255, 0.6);
    animation: modalPop 0.3s ease-out;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  .modal-content.wide {
    max-width: 700px;
    text-align: left;
  }

  @keyframes modalPop {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  .modal h2 {
    margin-top: 0;
    margin-bottom: 20px;
  }

  .modal p {
    color: #dacafa;
    font-size: 1em;
    line-height: 1.6;
    margin-bottom: 15px;
  }

  .modal strong {
    color: #bb33ff;
  }

  .modal a {
    display: inline-block;
    padding: 14px 28px;
    background: linear-gradient(135deg, #00ff88, #00cc6a);
    color: #000;
    text-decoration: none;
    border-radius: 10px;
    font-weight: bold;
    transition: transform 0.2s;
  }

  .modal a:hover {
    transform: scale(1.05);
  }

  .modal .close-modal {
    display: block;
    margin-top: 20px;
    color: #888;
    cursor: pointer;
    font-size: 0.9em;
    background: none;
    border: none;
    font-family: inherit;
  }

  .modal .close-modal:hover {
    color: #fff;
  }

  .close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    background: none;
    border: none;
    color: #888;
    font-size: 2em;
    cursor: pointer;
    line-height: 1;
  }

  .close-btn:hover {
    color: #fff;
  }

  #accessDeniedModal h2 {
    color: #ff4444;
  }

  #successModal .modal-content {
    border-color: #00ff88;
  }

  #successModal h2 {
    color: #00ff88;
  }

  #repayModal .modal-content {
    border-color: #00ff88;
  }

  #repayModal h2 {
    color: #00ff88;
  }

  .repay-breakdown {
    background: rgba(0, 0, 0, 0.5);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    text-align: left;
  }

  .repay-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #333;
  }

  .repay-row:last-child {
    border-bottom: none;
    font-weight: bold;
    color: #00ff88;
    font-size: 1.1em;
    padding-top: 15px;
  }

  .repay-row .label {
    color: #888;
  }

  .repay-row .value {
    color: #caffff;
  }

  .modal-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
  }

  .modal-btn {
    padding: 14px 28px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-family: inherit;
    font-size: 1em;
    transition: transform 0.2s;
  }

  .modal-btn:hover {
    transform: scale(1.05);
  }

  .modal-btn.primary {
    background: linear-gradient(135deg, #00ff88, #00cc6a);
    color: #000;
  }

  .modal-btn.secondary {
    background: #333;
    color: #fff;
  }

  /* Docs Modal Styles */
  .docs-section {
    margin-bottom: 25px;
  }

  .docs-section h3 {
    color: #bb33ff;
    font-size: 1.2em;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .docs-section p {
    margin-bottom: 10px;
  }

  .docs-box {
    background: rgba(0, 0, 0, 0.5);
    border: 2px solid #453c2c;
    border-radius: 12px;
    padding: 15px;
    margin: 15px 0;
  }

  .docs-box.highlight {
    border-color: #00ff88;
    background: rgba(0, 255, 136, 0.1);
  }

  .docs-box.warning {
    border-color: #ff4444;
    background: rgba(255, 68, 68, 0.1);
  }

  .docs-formula {
    background: rgba(187, 51, 255, 0.2);
    border: 1px solid #bb33ff;
    border-radius: 8px;
    padding: 12px;
    font-family: monospace;
    font-size: 0.95em;
    margin: 10px 0;
  }

  .docs-list {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }

  .docs-list li {
    padding: 8px 0;
    padding-left: 25px;
    position: relative;
  }

  .docs-list li:before {
    content: "‚úì";
    position: absolute;
    left: 0;
    color: #00ff88;
  }

  .docs-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
  }

  .docs-table th, .docs-table td {
    padding: 10px;
    border: 1px solid #453c2c;
    text-align: left;
  }

  .docs-table th {
    background: rgba(187, 51, 255, 0.2);
    color: #bb33ff;
  }

  .docs-table td {
    color: #caffff;
  }

  .governance-link {
    display: inline-block;
    margin-top: 15px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #bb33ff, #7a2bf8);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .governance-link:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px rgba(187, 51, 255, 0.5);
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .fixed-header {
      flex-direction: column;
      text-align: center;
    }

    .header-left {
      flex-direction: column;
    }

    .header-center {
      position: relative;
      left: auto;
      transform: none;
      order: -1;
      margin-bottom: 10px;
    }

    .header-stats {
      flex-wrap: wrap;
      justify-content: center;
    }

    .container {
      padding: 160px 15px 60px;
    }

    .title img {
      max-width: 280px;
    }

    .summary {
      font-size: 0.95em;
    }

    .tabs {
      justify-content: center;
    }

    .tab-btn {
      padding: 10px 16px;
      font-size: 0.85em;
    }

    .nft-grid {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .active-loans-grid {
      grid-template-columns: 1fr;
    }

    .global-stats {
      grid-template-columns: repeat(2, 1fr);
    }

    .loan-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .loan-box {
      padding: 12px;
      font-size: 0.9em;
    }

    .action-btn {
      padding: 12px 20px;
      font-size: 0.95em;
    }

    .collection-selector {
      justify-content: center;
    }

    .modal-content {
      padding: 20px;
    }

    .modal-content.wide {
      max-width: 95%;
    }

    .modal-buttons {
      flex-direction: column;
    }

    .docs-table {
      font-size: 0.85em;
    }
  }

  @media (max-width: 480px) {
    .global-stats {
      grid-template-columns: 1fr 1fr;
    }

    .stat-card {
      padding: 10px;
    }

    .stat-card .stat-value {
      font-size: 1.1em;
    }

    .nft-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .loan-card-details {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<!-- Fixed Header -->
<div class="fixed-header">
  <div class="header-left">
    <div class="header-logo">üêº Panda Pawn</div>
    <div class="header-stats">
      <div class="header-stat">Floor: <span id="headerFloor">--</span> PDA</div>
      <div class="header-stat">Your PDA: <span id="headerBalance">--</span></div>
    </div>
  </div>
  <div class="header-center">
    <button class="docs-btn" onclick="showModal('docsModal')">üìñ Docs</button>
  </div>
  <div class="header-right">
    <button id="connect-wallet-btn">üîó Connect Wallet</button>
    <div id="wallet-display"></div>
  </div>
</div>

<!-- Documentation Modal -->
<div id="docsModal" class="modal">
  <div class="modal-content wide">
    <button class="close-btn" onclick="closeModal('docsModal')">√ó</button>
    <h2 style="color: #bb33ff; text-align: center;">üìñ Panda Pawn Shop Documentation</h2>
    <p style="text-align: center; color: #888;">Everything you need to know about NFT-backed PDA loans</p>

    <!-- How It Works -->
    <div class="docs-section">
      <h3>üéØ How It Works</h3>
      <p>Panda Pawn Shop allows you to get instant PDA liquidity by using your Proton Pandas NFTs as collateral. Lock your NFT, receive PDA, and repay within 14 days to get your NFT back!</p>
      <ul class="docs-list">
        <li>Connect your WebAuth wallet</li>
        <li>Select a Proton Panda NFT from your wallet</li>
        <li>Click "Lend NFT for PDA" to create a loan</li>
        <li>Receive 5% of the floor price in PDA instantly</li>
        <li>Repay the loan + 10% interest within 14 days</li>
        <li>Get your NFT back!</li>
      </ul>
    </div>

    <!-- Requirements -->
    <div class="docs-section">
      <h3>üîê Requirements</h3>
      <div class="docs-box highlight">
        <p><strong>Minimum PDA Balance:</strong> You must hold at least <strong style="color: #00ff88;">555,555 PDA</strong> in your wallet to use the platform.</p>
        <p style="margin-bottom: 0;"><a href="https://proton.alcor.exchange/swap?input=XPR-eosio.token&output=PDA-xprpandas" target="_blank" style="padding: 8px 16px; font-size: 0.9em;">Buy PDA on Alcor</a></p>
      </div>
    </div>

    <!-- Loan Terms -->
    <div class="docs-section">
      <h3>üí∞ Loan Terms</h3>
      <table class="docs-table">
        <tr>
          <th>Parameter</th>
          <th>Value</th>
        </tr>
        <tr>
          <td>Loan Amount</td>
          <td>5% of NFT Floor Price</td>
        </tr>
        <tr>
          <td>Interest Rate</td>
          <td>10% flat (not APR)</td>
        </tr>
        <tr>
          <td>Loan Duration</td>
          <td>14 Days</td>
        </tr>
        <tr>
          <td>Interest Split</td>
          <td>60% Burned üî• / 40% to Vault</td>
        </tr>
      </table>
    </div>

    <!-- Calculator -->
    <div class="docs-section">
      <h3>üßÆ How to Calculate Your Loan</h3>
      <div class="docs-formula">
        <strong>Loan Amount</strong> = Floor Price √ó 5%<br>
        <strong>Interest</strong> = Loan Amount √ó 10%<br>
        <strong>Total Repayment</strong> = Loan Amount + Interest
      </div>
      <div class="docs-box">
        <p><strong>Example:</strong></p>
        <p>If Floor Price = <strong>2,082,863 PDA</strong></p>
        <ul class="docs-list">
          <li>Loan Amount = 2,082,863 √ó 5% = <strong>104,143.15 PDA</strong></li>
          <li>Interest = 104,143.15 √ó 10% = <strong>10,414.31 PDA</strong></li>
          <li>Total Repayment = 104,143.15 + 10,414.31 = <strong>114,557.46 PDA</strong></li>
        </ul>
      </div>
    </div>

    <!-- What Happens on Default -->
    <div class="docs-section">
      <h3>‚ö†Ô∏è What Happens If You Don't Repay?</h3>
      <div class="docs-box warning">
        <p><strong>If you fail to repay within 14 days:</strong></p>
        <ul class="docs-list" style="color: #ff6b6b;">
          <li style="color: #dacafa;">Your loan expires and becomes "defaulted"</li>
          <li style="color: #dacafa;">Your NFT is transferred to the PandaVault</li>
          <li style="color: #dacafa;">You keep the PDA you borrowed</li>
          <li style="color: #dacafa;">Your NFT may be auctioned or sold</li>
        </ul>
        <p style="margin-bottom: 0; color: #ff4444;"><strong>‚è∞ Always repay on time to keep your NFT!</strong></p>
      </div>
    </div>

    <!-- Interest Distribution -->
    <div class="docs-section">
      <h3>üî• Interest Distribution</h3>
      <p>When you repay your loan, the interest is split:</p>
      <div class="docs-box">
        <p>üî• <strong style="color: #ff4444;">60% BURNED</strong> - Sent to token.burn, permanently removed from supply</p>
        <p style="margin-bottom: 0;">üè¶ <strong style="color: #00ff88;">40% TO VAULT</strong> - Goes to PandaVault treasury</p>
      </div>
      <p style="color: #888; font-size: 0.9em;">This deflationary mechanism helps maintain PDA scarcity!</p>
    </div>

    <!-- FAQ -->
    <div class="docs-section">
      <h3>‚ùì FAQ</h3>
      <div class="docs-box">
        <p><strong>Q: Can I repay early?</strong></p>
        <p style="margin-bottom: 15px;">A: Yes! You can repay anytime before the 14-day deadline.</p>
        
        <p><strong>Q: Can I extend my loan?</strong></p>
        <p style="margin-bottom: 15px;">A: No, loans cannot be extended. You must repay within 14 days.</p>
        
        <p><strong>Q: What collections are supported?</strong></p>
        <p style="margin-bottom: 15px;">A: Currently only Proton Pandas. More collections coming soon!</p>
        
        <p><strong>Q: How is the floor price determined?</strong></p>
        <p style="margin-bottom: 0;">A: The floor price is set by the admin and updated periodically based on market conditions.</p>
      </div>
    </div>

    <!-- Governance Link -->
    <div class="docs-section">
      <h3>üó≥Ô∏è Governance</h3>
      <p>Participate in community governance and vote on proposals:</p>
      <a href="http://pandania.xyz/vote.html" target="_blank" class="governance-link">üó≥Ô∏è Go to Governance Portal</a>
    </div>

    <button class="close-modal" onclick="closeModal('docsModal')" style="text-align: center; width: 100%;">Close Documentation</button>
  </div>
</div>

<!-- Access Denied Modal -->
<div id="accessDeniedModal" class="modal">
  <div class="modal-content">
    <h2>üö´ ACCESS DENIED</h2>
    <p>üêº You need at least <strong>555,555 PDA</strong> tokens to use Panda Pawn Shop!</p>
    <a href="https://proton.alcor.exchange/swap?input=XPR-eosio.token&output=PDA-xprpandas" target="_blank">Buy PDA on Alcor Exchange</a>
    <button class="close-modal" onclick="closeModal('accessDeniedModal')">Close</button>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal">
  <div class="modal-content">
    <h2>‚úÖ LOAN CREATED!</h2>
    <p>Your loan has been created successfully!</p>
    <div id="loanDetails" class="repay-breakdown"></div>
    <button class="close-modal" onclick="closeModal('successModal')">Close</button>
  </div>
</div>

<!-- Repay Modal -->
<div id="repayModal" class="modal">
  <div class="modal-content">
    <h2>üí∞ REPAY LOAN</h2>
    <p>Repay your loan to get your NFT back!</p>
    <div id="repayDetails" class="repay-breakdown"></div>
    <div class="modal-buttons">
      <button class="modal-btn primary" id="confirmRepayBtn">Confirm Repay</button>
      <button class="modal-btn secondary" onclick="closeModal('repayModal')">Cancel</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="title">
    <img src="images/pandapawnshop.jpg" alt="Panda Pawn Shop">
  </div>

  <div class="summary">
    Lock your Proton Pandas NFTs to access short-term PDA liquidity.<br>
    Repay your loan to get your NFT back ‚Äî or default and the NFT goes to the vault.
    <br><br>
    üêº Small loans ‚Ä¢ ‚è± 14 Day terms ‚Ä¢ üî• 60% of interest burned
  </div>

  <!-- Global Stats -->
  <div class="global-stats">
    <div class="stat-card">
      <div class="stat-label">Floor Price</div>
      <div class="stat-value" id="statFloor">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Loan Amount Available</div>
      <div class="stat-value" id="statLoanAmount">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Loans</div>
      <div class="stat-value" id="statTotalLoans">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Outstanding</div>
      <div class="stat-value" id="statOutstanding">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Burned</div>
      <div class="stat-value red" id="statBurned">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Your Active Loans</div>
      <div class="stat-value green" id="statUserLoans">0</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="lend">üè¶ Lend NFT</button>
    <button class="tab-btn" data-tab="myloans" id="myLoansTab">
      üìã My Loans
      <span class="badge" id="loansBadge" style="display: none;">0</span>
    </button>
  </div>

  <!-- Lend Tab Content -->
  <div id="lend-tab" class="tab-content active">
    
    <!-- Collection Selector -->
    <div class="collection-selector">
      <button class="collection-btn active" data-collection="protonpandas">
        <img src="images/x-icon/pda-xprpanda-65x65.png" alt="Proton Pandas">
        Proton Pandas
      </button>
      <button class="collection-btn disabled" disabled>
        <span>üêª</span>
        <span>Vote your favorite Collection in soon!<span class="coming-soon-text"><br>Coming Soon</span></span>
      </button>
      <button class="collection-btn disabled" disabled>
        <span>ü¶ä</span>
        <span>Vote your favorite Collection in soon!<span class="coming-soon-text"><br>Coming Soon</span></span>
      </button>
    </div>

    <div class="section">
      <h2>
        Select Proton Panda to Lend
        <span class="floor-badge" id="floorBadge">Floor: -- PDA</span>
      </h2>
      <div class="nft-grid" id="nftGrid">
        <p style="color: #888;">Connect wallet to view your NFTs</p>
      </div>
    </div>

    <div class="section preview">
      <h2>Selected NFT</h2>
      <img id="selectedNFT" src="" style="display: none;">
      <p id="selectedInfo" style="color: #999;">No NFT selected</p>
      <div id="loanPreview" style="display: none; margin-top: 15px;">
        <p style="color: #00ff88;">You will receive: <strong id="previewAmount">-- PDA</strong></p>
        <p style="color: #888; font-size: 0.9em;">Repay: <span id="previewRepay">--</span> PDA within 14 days</p>
      </div>
      <br>
      <button class="action-btn" id="lendBtn" disabled>
        Lend NFT for PDA
        <img src="images/x-icon/pda-xprpanda-65x65.png" alt="PDA">
      </button>
    </div>

    <div class="section">
      <h2>Loan Terms</h2>
      <div class="loan-grid">
        <div class="loan-box">‚è± Duration<br><b>14 Days</b></div>
        <div class="loan-box">üí∞ Loan<br><b>5% of Floor</b></div>
        <div class="loan-box">üî• Interest<br><b>10%</b></div>
        <div class="loan-box">‚ôª Split<br><b>60% Burn / 40% Vault</b></div>
      </div>
    </div>
  </div>

  <!-- My Loans Tab Content -->
  <div id="myloans-tab" class="tab-content">
    <div class="section">
      <h2>üìã Your Active Loans</h2>
      <div class="active-loans-grid" id="activeLoansGrid">
        <div class="no-loans-message">
          <h3>No Active Loans</h3>
          <p>You don't have any active loans. Go to "Lend NFT" tab to create one!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@proton/web-sdk@latest"></script>

<script>
let session = null;
let actor = null;
let userLoans = [];
let countdownIntervals = [];

// Configuration
const PANDA_BACKEND = "https://panda-nft-backend.onrender.com";
const PAWN_CONTRACT = "pandapawn";
const PDA_CONTRACT = "xprpandas";
const ATOMICASSETS = "atomicassets";
const COLLECTION_NAME = "protonpandas";
const REQUIRED_PDA = 555555;

// IPFS Gateways - try multiple if one fails
const IPFS_GATEWAYS = [
  "https://ipfs.io/ipfs/",
  "https://cloudflare-ipfs.com/ipfs/",
  "https://gateway.pinata.cloud/ipfs/",
  "https://dweb.link/ipfs/"
];

// RPC Endpoints
const RPC_ENDPOINTS = [
  "https://proton.greymass.com",
  "https://proton.eosusa.io",
  "https://proton.pink.gg"
];

// Placeholder image SVG
const PLACEHOLDER_IMAGE = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%231a1a1a" width="200" height="200"/%3E%3Ctext fill="%23bb33ff" x="50%25" y="50%25" text-anchor="middle" dy=".3em" font-size="14"%3EPanda%3C/text%3E%3C/svg%3E';

// Fetch with fallback
async function fetchWithFallback(path, options) {
  for (let i = 0; i < RPC_ENDPOINTS.length; i++) {
    try {
      const response = await fetch(`${RPC_ENDPOINTS[i]}${path}`, options);
      if (response.ok) return response;
    } catch (error) {
      console.warn(`Endpoint ${RPC_ENDPOINTS[i]} failed:`, error);
      if (i === RPC_ENDPOINTS.length - 1) throw error;
    }
  }
  throw new Error('All endpoints failed');
}

// Check PDA Balance
async function checkPDABalance(accountName) {
  try {
    const response = await fetchWithFallback('/v1/chain/get_currency_balance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: PDA_CONTRACT,
        account: accountName,
        symbol: 'PDA'
      })
    });
    const balances = await response.json();
    const balance = parseFloat((balances[0] || '0 PDA').split(' ')[0]);
    return balance;
  } catch (error) {
    console.error('Error checking PDA balance:', error);
    return 0;
  }
}

// Get Contract Config
async function getContractConfig() {
  try {
    const response = await fetchWithFallback('/v1/chain/get_table_rows', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: PAWN_CONTRACT,
        scope: PAWN_CONTRACT,
        table: 'config',
        limit: 1,
        json: true
      })
    });
    const data = await response.json();
    return data.rows && data.rows.length > 0 ? data.rows[0] : null;
  } catch (error) {
    console.error('Error getting config:', error);
    return null;
  }
}

// Get Collection Config
async function getCollectionConfig() {
  try {
    const response = await fetchWithFallback('/v1/chain/get_table_rows', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: PAWN_CONTRACT,
        scope: PAWN_CONTRACT,
        table: 'collections',
        lower_bound: COLLECTION_NAME,
        upper_bound: COLLECTION_NAME,
        limit: 1,
        json: true
      })
    });
    const data = await response.json();
    return data.rows && data.rows.length > 0 ? data.rows[0] : null;
  } catch (error) {
    console.error('Error getting collection config:', error);
    return null;
  }
}

// Get User Loans (only status 0 = ACTIVE)
async function getUserLoans(accountName) {
  try {
    const response = await fetchWithFallback('/v1/chain/get_table_rows', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: PAWN_CONTRACT,
        scope: PAWN_CONTRACT,
        table: 'loans',
        limit: 100,
        json: true
      })
    });
    const data = await response.json();
    if (data.rows) {
      return data.rows.filter(loan => loan.borrower === accountName && loan.status === 0);
    }
    return [];
  } catch (error) {
    console.error('Error getting user loans:', error);
    return [];
  }
}

// Convert IPFS hash to gateway URL
function ipfsToGateway(imageUrl, gatewayIndex = 0) {
  if (!imageUrl) return null;
  
  const gateway = IPFS_GATEWAYS[gatewayIndex] || IPFS_GATEWAYS[0];
  
  if (imageUrl.startsWith('Qm') || imageUrl.startsWith('bafy')) {
    return gateway + imageUrl;
  } else if (imageUrl.startsWith('ipfs://')) {
    return gateway + imageUrl.replace('ipfs://', '');
  }
  return imageUrl;
}

// BATCH FETCH: Get all NFT images from AtomicAssets in ONE request (like loadNFTs does)
async function fetchLoanNFTImages(assetIds) {
  const imageMap = {};
  
  if (!assetIds || assetIds.length === 0) return imageMap;
  
  try {
    // Batch request - fetch ALL assets in one call
    const idsParam = assetIds.join(',');
    const response = await fetch(`https://proton.api.atomicassets.io/atomicassets/v1/assets?ids=${idsParam}&page=1&limit=100`);
    
    if (!response.ok) {
      console.error('AtomicAssets API error:', response.status);
      return imageMap;
    }
    
    const data = await response.json();
    
    if (data.success && data.data && Array.isArray(data.data)) {
      data.data.forEach(asset => {
        let imageUrl = null;
        
        // Try all possible image fields (same as loadNFTs backend returns)
        if (asset.data && asset.data.image) {
          imageUrl = asset.data.image;
        } else if (asset.immutable_data && asset.immutable_data.image) {
          imageUrl = asset.immutable_data.image;
        } else if (asset.data && asset.data.img) {
          imageUrl = asset.data.img;
        } else if (asset.immutable_data && asset.immutable_data.img) {
          imageUrl = asset.immutable_data.img;
        }
        
        if (imageUrl) {
          // Convert IPFS to gateway URL
          imageUrl = ipfsToGateway(imageUrl);
          imageMap[String(asset.asset_id)] = imageUrl;
        }
      });
    }
  } catch (error) {
    console.error('Error fetching loan NFT images:', error);
  }
  
  return imageMap;
}

// Update Global Stats
async function updateGlobalStats() {
  const config = await getContractConfig();
  const collection = await getCollectionConfig();

  if (collection) {
    const floorPrice = collection.floor_price / 100;
    const loanAmount = floorPrice * 0.05;
    
    document.getElementById('statFloor').textContent = floorPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' PDA';
    document.getElementById('statLoanAmount').textContent = loanAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' PDA';
    document.getElementById('headerFloor').textContent = floorPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById('floorBadge').textContent = `Floor: ${floorPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA`;
  }

  if (config) {
    document.getElementById('statTotalLoans').textContent = config.total_loans || '0';
    document.getElementById('statOutstanding').textContent = ((config.total_outstanding || 0) / 100).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' PDA';
    document.getElementById('statBurned').textContent = ((config.total_burned || 0) / 100).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' PDA';
  }
}

// Modal Functions
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

function showModal(modalId) {
  document.getElementById(modalId).classList.add('show');
}

// Format Time Remaining
function formatTimeRemaining(expiresAt) {
  const now = Math.floor(Date.now() / 1000);
  const remaining = expiresAt - now;
  
  if (remaining <= 0) return { text: 'EXPIRED', class: 'danger' };
  
  const days = Math.floor(remaining / 86400);
  const hours = Math.floor((remaining % 86400) / 3600);
  const minutes = Math.floor((remaining % 3600) / 60);
  const seconds = remaining % 60;
  
  let text = '';
  if (days > 0) text = `${days}d ${hours}h ${minutes}m`;
  else if (hours > 0) text = `${hours}h ${minutes}m ${seconds}s`;
  else text = `${minutes}m ${seconds}s`;
  
  let timerClass = '';
  if (days >= 7) timerClass = '';
  else if (days >= 1) timerClass = 'warning';
  else timerClass = 'danger';
  
  return { text, class: timerClass, days, hours };
}

// Clear all countdown intervals
function clearCountdowns() {
  countdownIntervals.forEach(interval => clearInterval(interval));
  countdownIntervals = [];
}

// Handle image load error - try next IPFS gateway
function handleImageError(img) {
  const currentGateway = parseInt(img.dataset.gatewayIndex || '0');
  const originalHash = img.dataset.ipfsHash;
  
  if (originalHash && currentGateway < IPFS_GATEWAYS.length - 1) {
    // Try next gateway
    const nextGateway = currentGateway + 1;
    img.dataset.gatewayIndex = nextGateway;
    img.src = IPFS_GATEWAYS[nextGateway] + originalHash;
  } else {
    // All gateways failed, use placeholder
    img.src = PLACEHOLDER_IMAGE;
  }
}

// Update User Loans Display - FIXED VERSION using same pattern as loadNFTs
async function updateUserLoansDisplay() {
  if (!actor) return;
  
  clearCountdowns();
  
  const loans = await getUserLoans(actor.toString());
  userLoans = loans;
  
  const badge = document.getElementById('loansBadge');
  const userLoansCount = loans.length;
  document.getElementById('statUserLoans').textContent = userLoansCount;
  
  if (userLoansCount > 0) {
    badge.textContent = userLoansCount;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
  
  const grid = document.getElementById('activeLoansGrid');
  
  if (loans.length === 0) {
    grid.innerHTML = `
      <div class="no-loans-message">
        <h3>No Active Loans</h3>
        <p>You don't have any active loans. Go to "Lend NFT" tab to create one!</p>
      </div>
    `;
    return;
  }
  
  // Show loading state first
  grid.innerHTML = '<p class="loading">üîÑ Loading your loans...</p>';
  
  // STEP 1: Get all asset IDs
  const assetIds = loans.map(loan => String(loan.asset_id));
  
  // STEP 2: Fetch ALL images in ONE batch request (like loadNFTs does with backend)
  const imageMap = await fetchLoanNFTImages(assetIds);
  
  // STEP 3: Clear grid and build loan cards with DOM manipulation (like loadNFTs)
  grid.innerHTML = '';
  
  loans.forEach((loan, index) => {
    const timeInfo = formatTimeRemaining(loan.expires_at);
    const loanAmount = loan.loan_amount / 100;
    const repayAmount = loan.repay_amount / 100;
    const assetIdStr = String(loan.asset_id);
    
    // Get image URL from our batch fetch
    let imageUrl = imageMap[assetIdStr] || PLACEHOLDER_IMAGE;
    
    // Extract IPFS hash for fallback retry
    let ipfsHash = null;
    if (imageUrl && !imageUrl.startsWith('data:')) {
      const match = imageUrl.match(/ipfs\/(.+)$/);
      if (match) ipfsHash = match[1];
    }
    
    // Create loan card element (like loadNFTs creates nft-card)
    const card = document.createElement('div');
    card.className = `loan-card ${timeInfo.class === 'danger' ? 'urgent' : ''}`;
    card.dataset.loanId = loan.loan_id;
    
    // Create image element with error handling (like loadNFTs)
    const imgHtml = `
      <div class="loan-card-header">
        <img class="loan-card-nft" 
             src="${imageUrl}" 
             alt="NFT"
             data-gateway-index="0"
             ${ipfsHash ? `data-ipfs-hash="${ipfsHash}"` : ''}
             onerror="handleImageError(this)">
        <div class="loan-card-info">
          <div class="loan-card-title">Proton Panda #${loan.asset_id}</div>
          <div class="loan-card-id">Loan #${loan.loan_id}</div>
        </div>
      </div>
      <div class="loan-card-timer">
        <div class="timer-label">Time Remaining</div>
        <div class="timer-value ${timeInfo.class}" id="timer${loan.loan_id}">${timeInfo.text}</div>
      </div>
      <div class="loan-card-details">
        <div class="loan-detail">
          <div class="loan-detail-label">Borrowed</div>
          <div class="loan-detail-value">${loanAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</div>
        </div>
        <div class="loan-detail">
          <div class="loan-detail-label">Repay Amount</div>
          <div class="loan-detail-value">${repayAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</div>
        </div>
      </div>
      <button class="repay-btn" onclick="openRepayModal(${loan.loan_id}, ${loan.loan_amount}, ${loan.repay_amount}, ${loan.asset_id})">
        üí∞ Repay & Get NFT Back
      </button>
    `;
    
    card.innerHTML = imgHtml;
    grid.appendChild(card);
  });
  
  // Start countdown timers
  loans.forEach(loan => {
    const interval = setInterval(() => {
      const timerEl = document.getElementById(`timer${loan.loan_id}`);
      if (timerEl) {
        const timeInfo = formatTimeRemaining(loan.expires_at);
        timerEl.textContent = timeInfo.text;
        timerEl.className = `timer-value ${timeInfo.class}`;
      }
    }, 1000);
    countdownIntervals.push(interval);
  });
}

// Open Repay Modal
function openRepayModal(loanId, loanAmount, repayAmount, assetId) {
  const principal = loanAmount / 100;
  const total = repayAmount / 100;
  const interest = total - principal;
  const burnAmount = interest * 0.6;
  const vaultAmount = interest * 0.4;
  
  document.getElementById('repayDetails').innerHTML = `
    <div class="repay-row">
      <span class="label">Loan ID</span>
      <span class="value">#${loanId}</span>
    </div>
    <div class="repay-row">
      <span class="label">NFT Asset ID</span>
      <span class="value">${assetId}</span>
    </div>
    <div class="repay-row">
      <span class="label">Principal</span>
      <span class="value">${principal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</span>
    </div>
    <div class="repay-row">
      <span class="label">Interest (10%)</span>
      <span class="value">${interest.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</span>
    </div>
    <div class="repay-row">
      <span class="label">‚Üí Burned (60%)</span>
      <span class="value" style="color: #ff4444;">${burnAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</span>
    </div>
    <div class="repay-row">
      <span class="label">‚Üí To Vault (40%)</span>
      <span class="value">${vaultAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</span>
    </div>
    <div class="repay-row">
      <span class="label">Total Repayment</span>
      <span class="value">${total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</span>
    </div>
  `;
  
  document.getElementById('confirmRepayBtn').onclick = () => repayLoan(loanId, repayAmount);
  showModal('repayModal');
}

// Repay Loan
async function repayLoan(loanId, repayAmount) {
  if (!session || !actor) {
    alert('Please connect your wallet first!');
    return;
  }
  
  const btn = document.getElementById('confirmRepayBtn');
  btn.textContent = '‚è≥ Processing...';
  btn.disabled = true;
  
  try {
    const repayAmountFormatted = (repayAmount / 100).toFixed(2) + ' PDA';
    
    const actions = [
      {
        account: PDA_CONTRACT,
        name: 'transfer',
        authorization: [{ actor: actor.toString(), permission: 'active' }],
        data: {
          from: actor.toString(),
          to: PAWN_CONTRACT,
          quantity: repayAmountFormatted,
          memo: `repay:${loanId}`
        }
      },
      {
        account: PAWN_CONTRACT,
        name: 'repayloan',
        authorization: [{ actor: actor.toString(), permission: 'active' }],
        data: {
          borrower: actor.toString(),
          loan_id: loanId
        }
      },
      {
        account: PAWN_CONTRACT,
        name: 'claimrepay',
        authorization: [{ actor: actor.toString(), permission: 'active' }],
        data: {
          borrower: actor.toString()
        }
      }
    ];
    
    const result = await session.transact({ actions }, { broadcast: true });
    console.log('Repay result:', result);
    
    closeModal('repayModal');
    alert('‚úÖ Loan repaid successfully! Your NFT has been returned.');
    
    await updateUserLoansDisplay();
    await updateGlobalStats();
    const pdaBalance = await checkPDABalance(actor.toString());
    document.getElementById('headerBalance').textContent = pdaBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    
  } catch (error) {
    console.error('Repay error:', error);
    alert(`‚ùå Failed to repay loan: ${error.message}`);
  } finally {
    btn.textContent = 'Confirm Repay';
    btn.disabled = false;
  }
}

// Create Loan
async function createLoan(nft) {
  if (!session || !actor) {
    alert('Please connect your wallet first!');
    return;
  }

  const lendBtn = document.getElementById('lendBtn');
  const originalText = lendBtn.innerHTML;

  try {
    lendBtn.disabled = true;
    lendBtn.innerHTML = '‚è≥ Checking PDA Balance...';

    const pdaBalance = await checkPDABalance(actor.toString());
    
    if (pdaBalance < REQUIRED_PDA) {
      showModal('accessDeniedModal');
      lendBtn.innerHTML = originalText;
      lendBtn.disabled = false;
      return;
    }

    lendBtn.innerHTML = '‚è≥ Getting Collection Info...';

    const collectionConfig = await getCollectionConfig();
    if (!collectionConfig) {
      throw new Error('Collection not configured in contract. Please contact admin.');
    }

    const floorPrice = collectionConfig.floor_price / 100;
    const loanAmount = floorPrice * 0.05;
    const repayAmount = loanAmount * 1.10;

    lendBtn.innerHTML = '‚è≥ Creating Loan...';

    const actions = [
      {
        account: ATOMICASSETS,
        name: 'transfer',
        authorization: [{ actor: actor.toString(), permission: 'active' }],
        data: {
          from: actor.toString(),
          to: PAWN_CONTRACT,
          asset_ids: [parseInt(nft.asset_id)],
          memo: 'loan'
        }
      },
      {
        account: PAWN_CONTRACT,
        name: 'createloan',
        authorization: [{ actor: actor.toString(), permission: 'active' }],
        data: {
          borrower: actor.toString(),
          asset_id: parseInt(nft.asset_id),
          template_id: parseInt(nft.template_id),
          collection_name: COLLECTION_NAME
        }
      }
    ];

    const result = await session.transact({ actions }, { broadcast: true });
    console.log('Loan created:', result);

    document.getElementById('loanDetails').innerHTML = `
      <div class="repay-row">
        <span class="label">NFT</span>
        <span class="value">${nft.name}</span>
      </div>
      <div class="repay-row">
        <span class="label">Loan Amount</span>
        <span class="value">${loanAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</span>
      </div>
      <div class="repay-row">
        <span class="label">Repay Amount</span>
        <span class="value">${repayAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} PDA</span>
      </div>
      <div class="repay-row">
        <span class="label">Duration</span>
        <span class="value">14 Days</span>
      </div>
    `;
    showModal('successModal');

    await loadNFTs(actor.toString());
    await updateUserLoansDisplay();
    await updateGlobalStats();
    
    const newBalance = await checkPDABalance(actor.toString());
    document.getElementById('headerBalance').textContent = newBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

    document.getElementById('selectedNFT').style.display = 'none';
    document.getElementById('selectedInfo').innerText = 'No NFT selected';
    document.getElementById('loanPreview').style.display = 'none';
    window.selectedNFT = null;

  } catch (error) {
    console.error('Loan creation error:', error);
    alert(`‚ùå Failed to create loan: ${error.message}`);
  } finally {
    lendBtn.innerHTML = originalText;
    lendBtn.disabled = !window.selectedNFT;
  }
}

// Load NFTs - THIS IS THE WORKING VERSION, loans section now uses same pattern
async function loadNFTs(wallet) {
  const nftGrid = document.getElementById("nftGrid");
  nftGrid.innerHTML = '<p class="loading">üîÑ Loading Proton Pandas...</p>';

  try {
    const resp = await fetch(`${PANDA_BACKEND}/api/pandas?wallet=${wallet}`);
    if (!resp.ok) throw new Error(`Backend returned ${resp.status}`);

    const nfts = await resp.json();
    nftGrid.innerHTML = "";

    if (!Array.isArray(nfts) || nfts.length === 0) {
      nftGrid.innerHTML = "<p>No Proton Pandas found in your wallet.</p>";
      return;
    }

    const collectionConfig = await getCollectionConfig();
    const floorPrice = collectionConfig ? collectionConfig.floor_price / 100 : 0;
    const loanAmount = floorPrice * 0.05;
    const repayAmount = loanAmount * 1.10;

    nfts.forEach(nft => {
      const card = document.createElement("div");
      card.className = "nft-card";

      const img = document.createElement("img");
      img.src = nft.image;
      img.alt = nft.name;
      img.loading = "lazy";
      
      if (nft.fallback_urls) {
        img.dataset.fallbacks = JSON.stringify(nft.fallback_urls);
        img.dataset.fallbackIndex = '0';
      }
      
      img.onerror = function() {
        if (this.dataset.fallbacks) {
          const fallbacks = JSON.parse(this.dataset.fallbacks);
          const currentIndex = parseInt(this.dataset.fallbackIndex || '0');
          if (currentIndex < fallbacks.length) {
            this.src = fallbacks[currentIndex];
            this.dataset.fallbackIndex = (currentIndex + 1).toString();
            return;
          }
        }
        this.src = PLACEHOLDER_IMAGE;
      };

      const name = document.createElement("div");
      name.className = "nft-name";
      name.innerText = nft.name;

      card.appendChild(img);
      card.appendChild(name);

      card.onclick = () => {
        document.querySelectorAll('.nft-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        
        document.getElementById("selectedNFT").src = nft.image;
        document.getElementById("selectedNFT").style.display = 'block';
        document.getElementById("selectedInfo").innerText = nft.name;
        document.getElementById("lendBtn").disabled = false;
        
        document.getElementById("loanPreview").style.display = 'block';
        document.getElementById("previewAmount").textContent = loanAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' PDA';
        document.getElementById("previewRepay").textContent = repayAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        window.selectedNFT = nft;
      };

      nftGrid.appendChild(card);
    });

  } catch (err) {
    console.error("NFT load error:", err);
    nftGrid.innerHTML = `<div class="error-message">Error loading NFTs: ${err.message}</div>`;
  }
}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    if (this.classList.contains('disabled')) return;
    
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    this.classList.add('active');
    const tabId = this.dataset.tab + '-tab';
    document.getElementById(tabId).classList.add('active');
    
    if (this.dataset.tab === 'myloans' && actor) {
      updateUserLoansDisplay();
    }
  });
});

// Connect Wallet
document.getElementById("connect-wallet-btn").addEventListener("click", async () => {
  const connectBtn = document.getElementById("connect-wallet-btn");
  const walletDisplay = document.getElementById("wallet-display");

  try {
    connectBtn.textContent = '‚è≥ Connecting...';
    connectBtn.disabled = true;

    const { session: newSession } = await ProtonWebSDK({
      linkOptions: { endpoints: ["https://proton.greymass.com"] },
      selectorOptions: { appName: "Panda Pawn Shop", appLogo: "images/pandapawnshop.jpg" },
      transportOptions: { requestAccount: "pandapawn" }
    });

    session = newSession;
    if (!session || !session.auth) throw new Error("No wallet auth returned");

    actor = session.auth.actor;
    
    const pdaBalance = await checkPDABalance(actor.toString());
    
    walletDisplay.innerHTML = `‚úÖ ${actor}`;
    document.getElementById('headerBalance').textContent = pdaBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    connectBtn.textContent = '‚úÖ Connected';

    await loadNFTs(actor.toString());
    await updateUserLoansDisplay();
    await updateGlobalStats();

  } catch (err) {
    console.error(err);
    walletDisplay.innerHTML = `<span style="color: #ff6b6b;">‚ùå ${err.message}</span>`;
    connectBtn.textContent = 'üîó Connect Wallet';
    connectBtn.disabled = false;
  }
});

// Lend Button
document.getElementById("lendBtn").addEventListener("click", async () => {
  if (!session) {
    document.getElementById("connect-wallet-btn").click();
    return;
  }

  if (window.selectedNFT) {
    await createLoan(window.selectedNFT);
  } else {
    alert('Please select an NFT first!');
  }
});

// Close modals on background click
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('show');
    }
  });
});

// Initialize stats on page load
updateGlobalStats();
</script>

</body>
</html>
