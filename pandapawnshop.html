<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panda Pawn Shop</title>

<style>
  body {
    margin: 0;
    font-family: 'Orbitron', Arial, sans-serif;
    background: #000;
    color: #f5e9ff;
  }

  #connect-wallet-btn {
    padding: 14px 22px;
    font-size: 1.05em;
    font-weight: bold;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #bb33ff, #7a2bf8);
    color: white;
    box-shadow: 0 0 12px #bb33ff, 0 0 26px #a020f0, 0 0 48px #bb33ff;
    animation: neonPulse 2s infinite;
  }

  @keyframes neonPulse {
    0%,100% { box-shadow: 0 0 12px #bb33ff,0 0 26px #a020f0,0 0 48px #bb33ff; }
    50% { box-shadow: 0 0 24px #d175ff,0 0 48px #bb33ff,0 0 90px #d175ff; }
  }

  #wallet-display {
    margin-top: 10px;
    font-size: 0.95em;
    color: #caffff;
  }

  .container { max-width: 1200px; margin: 0 auto; padding: 120px 20px 60px; }
  .title { text-align: center; margin-bottom: 30px; }
  .title img {
    max-width: 420px;
    width: 90%;
    filter: drop-shadow(0 0 18px #bb33ff) drop-shadow(0 0 36px #a020f0) drop-shadow(0 0 64px #bb33ff);
    animation: titleGlow 2.2s infinite ease-in-out;
  }
  @keyframes titleGlow {
    0%,100% {
      filter: drop-shadow(0 0 18px #bb33ff) drop-shadow(0 0 36px #a020f0) drop-shadow(0 0 64px #bb33ff);
    }
    50% {
      filter: drop-shadow(0 0 30px #d175ff) drop-shadow(0 0 60px #bb33ff) drop-shadow(0 0 110px #d175ff);
    }
  }

  .summary { max-width: 780px; margin: 0 auto 50px; text-align: center; line-height: 1.7; font-size: 1.05em; color: #dacafa; }
  .section { background: #120c1f; border: 2px solid #7a2bf8; border-radius: 18px; padding: 24px; margin-bottom: 40px; box-shadow: 0 0 24px rgba(122,43,248,0.35); }
  .section h2 { margin-top: 0; color: #e2c7ff; text-shadow: 0 0 10px #bb33ff; }
  .nft-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 18px; }
  .nft-card { background: #000; border-radius: 14px; border: 2px solid #453c2c; padding: 12px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
  .nft-card:hover { transform: translateY(-4px); box-shadow: 0 0 18px #bb33ff; }
  .nft-card.selected { border-color: #bb33ff; box-shadow: 0 0 18px #bb33ff; }
  .nft-card img { width: 100%; border-radius: 10px; margin-bottom: 8px; min-height: 150px; object-fit: cover; background: #1a1a1a; }
  .nft-card .nft-name { font-size: 0.85em; color: #dacafa; word-break: break-word; }
  .preview { text-align: center; }
  .preview img { max-width: 260px; border-radius: 18px; border: 3px solid #bb33ff; box-shadow: 0 0 28px rgba(187,51,255,0.6); }
  .loan-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 18px; }
  .loan-box { background:#000; border:2px solid #453c2c; border-radius:14px; padding:16px; text-align:center; }
  .action-btn { margin-top: 18px; padding: 14px 28px; border-radius: 12px; border: none; font-size: 1.05em; font-weight: bold; background: linear-gradient(135deg, #bb33ff, #892dff); color: #fff; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 0 22px rgba(187,51,255,0.45); }
  .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .action-btn img { width: 28px; height: 28px; }
  .countdown { margin-top: 15px; font-size: 1.1em; color: #ffbfff; }
  .error-message { color: #ff6b6b; margin-top: 10px; padding: 10px; background: rgba(255,107,107,0.1); border-radius: 8px; }
  .loading { color: #bb33ff; }

  /* Access Denied Modal Styles */
  #accessDeniedModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }

  #accessDeniedModal.show {
    display: flex;
  }

  #accessDeniedModal .modal-content {
    background: linear-gradient(135deg, #1a0a2e, #0d0015);
    border: 3px solid #bb33ff;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    max-width: 450px;
    box-shadow: 0 0 50px rgba(187, 51, 255, 0.6);
    animation: modalPop 0.3s ease-out;
  }

  @keyframes modalPop {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  #accessDeniedModal h2 {
    color: #ff4444;
    font-size: 1.8em;
    margin-bottom: 20px;
    text-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
  }

  #accessDeniedModal p {
    color: #dacafa;
    font-size: 1.1em;
    line-height: 1.6;
    margin-bottom: 25px;
  }

  #accessDeniedModal strong {
    color: #bb33ff;
    font-size: 1.2em;
  }

  #accessDeniedModal a {
    display: inline-block;
    padding: 14px 28px;
    background: linear-gradient(135deg, #00ff88, #00cc6a);
    color: #000;
    text-decoration: none;
    border-radius: 10px;
    font-weight: bold;
    font-size: 1em;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
  }

  #accessDeniedModal a:hover {
    transform: scale(1.05);
    box-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
  }

  #accessDeniedModal .close-modal {
    display: block;
    margin-top: 20px;
    color: #888;
    cursor: pointer;
    font-size: 0.9em;
  }

  #accessDeniedModal .close-modal:hover {
    color: #fff;
  }

  /* Success Modal Styles */
  #successModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }

  #successModal.show {
    display: flex;
  }

  #successModal .modal-content {
    background: linear-gradient(135deg, #0a2e1a, #001509);
    border: 3px solid #00ff88;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    max-width: 450px;
    box-shadow: 0 0 50px rgba(0, 255, 136, 0.6);
    animation: modalPop 0.3s ease-out;
  }

  #successModal h2 {
    color: #00ff88;
    font-size: 1.8em;
    margin-bottom: 20px;
  }

  #successModal p {
    color: #dacafa;
    font-size: 1.1em;
    line-height: 1.6;
    margin-bottom: 15px;
  }

  #successModal .close-modal {
    display: inline-block;
    margin-top: 20px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #bb33ff, #892dff);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- Access Denied Modal -->
<div id="accessDeniedModal">
  <div class="modal-content">
    <h2>üö´ ACCESS DENIED</h2>
    <p>üêº You need at least <strong>555,555 PDA</strong> tokens to use Panda Pawn Shop!</p>
    <a href="https://proton.alcor.exchange/swap?input=XPR-eosio.token&output=PDA-xprpandas" target="_blank">Buy PDA on Alcor Exchange</a>
    <span class="close-modal" onclick="closeAccessDeniedModal()">Close</span>
  </div>
</div>

<!-- Success Modal -->
<div id="successModal">
  <div class="modal-content">
    <h2>‚úÖ LOAN CREATED!</h2>
    <p id="successMessage">Your loan has been created successfully!</p>
    <p id="loanDetails"></p>
    <button class="close-modal" onclick="closeSuccessModal()">Close</button>
  </div>
</div>

<div style="text-align:center; padding: 20px;">
  <button id="connect-wallet-btn">üîó Connect Wallet</button>
  <div id="wallet-display"></div>
</div>

<div class="container">
  <div class="title">
    <img src="images/pandapawnshop.jpg" alt="Panda Pawn Shop">
  </div>

  <div class="summary">
    Lock your Proton Pandas NFTs to access short-term PDA liquidity.<br>
    Repay your loan to get your NFT back ‚Äî or default and the NFT enters a PDA-only auction.
    <br><br>
    üêº Small loans ‚Ä¢ ‚è± Short terms ‚Ä¢ üî• PDA burned on interest
  </div>

  <div class="section">
    <h2>Select Proton Panda to Lend</h2>
    <div class="nft-grid" id="nftGrid"></div>
  </div>

  <div class="section preview">
    <h2>Selected NFT</h2>
    <img id="selectedNFT" src="" style="display: none;">
    <p id="selectedInfo" style="color: #999;">No NFT selected</p>
    <br>
    <button class="action-btn" id="lendBtn" disabled>
      Lend NFT for PDA
      <img src="images/x-icon/pda-xprpanda-65x65.png" alt="PDA">
    </button>
    <div class="countdown" id="countdown"></div>
  </div>

  <div class="section">
    <h2>Loan Terms</h2>
    <div class="loan-grid">
      <div class="loan-box">‚è± Duration<br><b>14 Days</b></div>
      <div class="loan-box">üí∞ Loan<br><b>5% of Floor</b></div>
      <div class="loan-box">üî• Interest<br><b>10%</b></div>
      <div class="loan-box">‚ôª Split<br><b>60% Burn / 40% Vault</b></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@proton/web-sdk@latest"></script>

<script>
let session = null;
let actor = null;

// Configuration
const PANDA_BACKEND = "https://panda-nft-backend.onrender.com";
const PAWN_CONTRACT = "pandapawn";
const PDA_CONTRACT = "xprpandas";
const ATOMICASSETS = "atomicassets";
const COLLECTION_NAME = "protonpandas";
const REQUIRED_PDA = 555555;

// RPC Endpoints with fallback
const RPC_ENDPOINTS = [
  "https://proton.greymass.com",
  "https://proton.eosusa.io",
  "https://proton.pink.gg"
];

// Fetch with endpoint fallback
async function fetchWithFallback(path, options) {
  for (let i = 0; i < RPC_ENDPOINTS.length; i++) {
    try {
      const response = await fetch(`${RPC_ENDPOINTS[i]}${path}`, options);
      if (response.ok) {
        return response;
      }
    } catch (error) {
      console.warn(`Endpoint ${RPC_ENDPOINTS[i]} failed:`, error);
      if (i === RPC_ENDPOINTS.length - 1) throw error;
    }
  }
  throw new Error('All endpoints failed');
}

// Check PDA Balance
async function checkPDABalance(accountName) {
  try {
    const response = await fetchWithFallback('/v1/chain/get_currency_balance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: PDA_CONTRACT,
        account: accountName,
        symbol: 'PDA'
      })
    });
    const balances = await response.json();
    console.log('PDA Balance:', balances);
    const balance = parseFloat((balances[0] || '0 PDA').split(' ')[0]);
    return balance;
  } catch (error) {
    console.error('Error checking PDA balance:', error);
    return 0;
  }
}

// Show Access Denied Modal
function showAccessDeniedModal() {
  document.getElementById('accessDeniedModal').classList.add('show');
}

// Close Access Denied Modal
function closeAccessDeniedModal() {
  document.getElementById('accessDeniedModal').classList.remove('show');
}

// Show Success Modal
function showSuccessModal(loanId, amount) {
  document.getElementById('loanDetails').innerHTML = `
    <strong>Loan ID:</strong> #${loanId}<br>
    <strong>Amount:</strong> ${amount} PDA<br>
    <strong>Duration:</strong> 14 Days<br>
    <strong>Interest:</strong> 10%
  `;
  document.getElementById('successModal').classList.add('show');
}

// Close Success Modal
function closeSuccessModal() {
  document.getElementById('successModal').classList.remove('show');
}

// Get collection config from contract
async function getCollectionConfig() {
  try {
    const response = await fetchWithFallback('/v1/chain/get_table_rows', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code: PAWN_CONTRACT,
        scope: PAWN_CONTRACT,
        table: 'collections',
        lower_bound: COLLECTION_NAME,
        upper_bound: COLLECTION_NAME,
        limit: 1,
        json: true
      })
    });
    const data = await response.json();
    if (data.rows && data.rows.length > 0) {
      return data.rows[0];
    }
    return null;
  } catch (error) {
    console.error('Error getting collection config:', error);
    return null;
  }
}

// Create Loan Transaction
async function createLoan(nft) {
  if (!session || !actor) {
    alert('Please connect your wallet first!');
    return;
  }

  const lendBtn = document.getElementById('lendBtn');
  const originalText = lendBtn.innerHTML;

  try {
    // Disable button and show loading
    lendBtn.disabled = true;
    lendBtn.innerHTML = '‚è≥ Checking PDA Balance...';

    // Check PDA balance first
    const pdaBalance = await checkPDABalance(actor.toString());
    console.log(`PDA Balance: ${pdaBalance}, Required: ${REQUIRED_PDA}`);

    if (pdaBalance < REQUIRED_PDA) {
      showAccessDeniedModal();
      lendBtn.innerHTML = originalText;
      lendBtn.disabled = false;
      return;
    }

    lendBtn.innerHTML = '‚è≥ Creating Loan...';

    // Get collection config to calculate loan amount
    const collectionConfig = await getCollectionConfig();
    if (!collectionConfig) {
      throw new Error('Collection not configured in contract');
    }

    const floorPrice = collectionConfig.floor_price / 10000; // Convert from 4 decimals
    const loanAmount = floorPrice * 0.05; // 5% of floor

    // Transaction: Transfer NFT to contract then create loan
    const actions = [
      // Step 1: Transfer NFT to pandapawn contract
      {
        account: ATOMICASSETS,
        name: 'transfer',
        authorization: [{ actor: actor.toString(), permission: 'active' }],
        data: {
          from: actor.toString(),
          to: PAWN_CONTRACT,
          asset_ids: [nft.asset_id],
          memo: 'loan'
        }
      },
      // Step 2: Create loan record
      {
        account: PAWN_CONTRACT,
        name: 'createloan',
        authorization: [{ actor: actor.toString(), permission: 'active' }],
        data: {
          borrower: actor.toString(),
          asset_id: nft.asset_id,
          template_id: nft.template_id,
          collection_name: COLLECTION_NAME
        }
      }
    ];

    console.log('Sending transaction:', actions);

    const result = await session.transact({ actions }, {
      broadcast: true
    });

    console.log('Transaction result:', result);

    // Show success
    showSuccessModal(nft.asset_id, loanAmount.toFixed(4));

    // Refresh NFT list
    await loadNFTs(actor.toString());

    // Reset selection
    document.getElementById('selectedNFT').style.display = 'none';
    document.getElementById('selectedInfo').innerText = 'No NFT selected';
    window.selectedNFT = null;

  } catch (error) {
    console.error('Loan creation error:', error);
    alert(`‚ùå Failed to create loan: ${error.message}`);
  } finally {
    lendBtn.innerHTML = originalText;
    lendBtn.disabled = !window.selectedNFT;
  }
}

// Load NFTs
async function loadNFTs(wallet) {
  const nftGrid = document.getElementById("nftGrid");
  nftGrid.innerHTML = '<p class="loading">üîÑ Loading Proton Pandas...</p>';

  try {
    const resp = await fetch(`${PANDA_BACKEND}/api/pandas?wallet=${wallet}`);
    if (!resp.ok) throw new Error(`Backend returned ${resp.status}`);

    const nfts = await resp.json();
    console.log('Received NFTs:', nfts);

    nftGrid.innerHTML = "";

    if (!Array.isArray(nfts) || nfts.length === 0) {
      nftGrid.innerHTML = "<p>No Proton Pandas found.</p>";
      return;
    }

    nfts.forEach(nft => {
      const card = document.createElement("div");
      card.className = "nft-card";

      const img = document.createElement("img");
      img.src = nft.image;
      img.alt = nft.name;
      img.loading = "lazy";
      
      if (nft.fallback_urls) {
        img.dataset.fallbacks = JSON.stringify(nft.fallback_urls);
        img.dataset.fallbackIndex = '0';
      }
      
      img.onerror = function() {
        if (img.dataset.fallbacks) {
          const fallbacks = JSON.parse(img.dataset.fallbacks);
          const currentIndex = parseInt(img.dataset.fallbackIndex || '0');
          
          if (currentIndex < fallbacks.length) {
            img.src = fallbacks[currentIndex];
            img.dataset.fallbackIndex = (currentIndex + 1).toString();
            return;
          }
        }
        img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23333" width="200" height="200"/%3E%3Ctext fill="%23fff" x="50%25" y="50%25" text-anchor="middle" dy=".3em"%3EPanda %23' + nft.template_id + '%3C/text%3E%3C/svg%3E';
      };

      const name = document.createElement("div");
      name.className = "nft-name";
      name.innerText = nft.name;

      card.appendChild(img);
      card.appendChild(name);

      card.onclick = () => {
        document.querySelectorAll('.nft-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        
        document.getElementById("selectedNFT").src = nft.image;
        document.getElementById("selectedNFT").style.display = 'block';
        document.getElementById("selectedInfo").innerText = nft.name;
        document.getElementById("lendBtn").disabled = false;
        window.selectedNFT = nft;
      };

      nftGrid.appendChild(card);
    });

  } catch (err) {
    console.error("NFT load error:", err);
    nftGrid.innerHTML = `<div class="error-message">Error loading NFTs: ${err.message}</div>`;
  }
}

// Connect Wallet
document.getElementById("connect-wallet-btn").addEventListener("click", async () => {
  const connectBtn = document.getElementById("connect-wallet-btn");
  const walletDisplay = document.getElementById("wallet-display");

  try {
    connectBtn.textContent = '‚è≥ Connecting...';
    connectBtn.disabled = true;

    const { session: newSession } = await ProtonWebSDK({
      linkOptions: { endpoints: ["https://proton.greymass.com"] },
      selectorOptions: { appName: "Panda Pawn Shop", appLogo: "images/pandapawnshop.jpg" },
      transportOptions: { requestAccount: "pandapawn" }
    });

    session = newSession;
    if (!session || !session.auth) throw new Error("No wallet auth returned");

    actor = session.auth.actor;
    
    // Check PDA balance on connect
    const pdaBalance = await checkPDABalance(actor.toString());
    
    walletDisplay.innerHTML = `‚úÖ Connected: ${actor}<br><span style="color: #bb33ff;">üí∞ PDA Balance: ${pdaBalance.toLocaleString()}</span>`;
    connectBtn.textContent = '‚úÖ Connected';

    await loadNFTs(actor.toString());

  } catch (err) {
    console.error(err);
    walletDisplay.innerHTML = `<div class="error-message">‚ùå ${err.message}</div>`;
    connectBtn.textContent = 'üîó Connect Wallet';
    connectBtn.disabled = false;
  }
});

// Lend Button Click
document.getElementById("lendBtn").addEventListener("click", async () => {
  if (!session) {
    // If not connected, trigger wallet connection first
    document.getElementById("connect-wallet-btn").click();
    return;
  }

  if (window.selectedNFT) {
    await createLoan(window.selectedNFT);
  } else {
    alert('Please select an NFT first!');
  }
});

// Close modals on background click
document.getElementById('accessDeniedModal').addEventListener('click', (e) => {
  if (e.target.id === 'accessDeniedModal') {
    closeAccessDeniedModal();
  }
});

document.getElementById('successModal').addEventListener('click', (e) => {
  if (e.target.id === 'successModal') {
    closeSuccessModal();
  }
});
</script>

</body>
</html>
